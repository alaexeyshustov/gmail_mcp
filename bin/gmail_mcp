#!/usr/bin/env ruby

require 'dry/cli'
require 'fileutils'

module GmailMCP
  module CLI
    module Commands
      extend Dry::CLI::Registry

      class Setup < Dry::CLI::Command
        desc 'Set up the Gmail MCP server (create directories, check credentials, install dependencies)'

        def call(*)
          require 'yaml'

          puts '=== Gmail MCP Server Setup ==='
          puts

          # Create credentials directory
          config_path      = File.expand_path('../../config.yml', __FILE__)
          config           = YAML.load_file(config_path)
          credentials_path = File.expand_path(config['credentials_path'])

          # Check for credentials file
          if File.exist?(credentials_path)
            puts "✓ Credentials file found: #{credentials_path}"
          else
            puts '✗ Credentials file not found'
            puts
            puts 'Please follow these steps:'
            puts '1. Go to https://console.cloud.google.com/'
            puts '2. Create a new project or select an existing one'
            puts '3. Enable the Gmail API'
            puts '4. Create OAuth 2.0 credentials (Desktop app)'
            puts '5. Download the credentials JSON file'
            puts "6. Save it to: #{credentials_path}"
            puts
            print "Press Enter after you've saved the credentials file..."
            $stdin.gets

            unless File.exist?(credentials_path)
              puts '✗ Credentials file still not found. Exiting.'
              exit 1
            end

            puts '✓ Credentials file found!'
          end

          puts
          puts '=== Installing dependencies ==='
          system('bundle install')

          puts
          puts '=== Setup complete! ==='
          puts
          puts 'To start the server, run:'
          puts 'bin/gmail_mcp server'
          puts
          puts 'For GitHub Copilot integration, see README.md'
        end
      end

      class Test < Dry::CLI::Command
        desc 'Test the Gmail integration without running the full MCP server'

        def call(*)
          require 'google/apis/gmail_v1'
          require 'googleauth'
          require 'googleauth/stores/file_token_store'
          require 'yaml'

          config_path      = File.expand_path('../../config.yml', __FILE__)
          config           = YAML.load_file(config_path)
          credentials_path = File.expand_path(config['credentials_path'])
          token_path       = File.expand_path(config['token_path'])
          scope            = Google::Apis::GmailV1::AUTH_GMAIL_READONLY

          puts '=== Gmail MCP Server Test ==='
          puts

          # Check credentials
          unless File.exist?(credentials_path)
            puts "✗ ERROR: Credentials file not found at #{credentials_path}"
            puts '  Please follow the setup instructions in README.md'
            exit 1
          end
          puts '✓ Credentials file found'

          # Initialize service
          puts '✓ Initializing Gmail service...'
          service = Google::Apis::GmailV1::GmailService.new
          service.client_options.application_name = 'Gmail MCP Server Test'

          # Authorize
          puts '✓ Authorizing...'
          service.authorization = authorize(credentials_path, token_path, scope)
          puts '✓ Authorization successful'

          # Test: Get profile
          puts
          puts 'Testing profile access...'
          profile = service.get_user_profile('me')
          puts "✓ Profile: #{profile.email_address}"
          puts "  Total messages: #{profile.messages_total}"
          puts "  Total threads: #{profile.threads_total}"

          # Test: Get labels
          puts
          puts 'Testing labels access...'
          result = service.list_user_labels('me')
          puts "✓ Found #{result.labels.length} labels:"
          result.labels.first(5).each { |label| puts "  - #{label.name}" }
          puts '  ...' if result.labels.length > 5

          # Test: List messages
          puts
          puts 'Testing messages access...'
          result = service.list_user_messages('me', max_results: 5)
          messages_count = result.messages ? result.messages.length : 0
          puts "✓ Found #{messages_count} recent messages"

          if messages_count > 0
            puts
            puts 'Testing message retrieval...'
            message = service.get_user_message('me', result.messages.first.id)
            headers = message.payload.headers
            subject = headers.find { |h| h.name == 'Subject' }&.value || '(No Subject)'
            from    = headers.find { |h| h.name == 'From' }&.value || 'Unknown'
            puts '✓ Retrieved message:'
            puts "  From: #{from}"
            puts "  Subject: #{subject}"
            puts "  Snippet: #{message.snippet[0..100]}..."
          end

          # Test: Get unread count
          puts
          puts 'Testing unread count...'
          unread_label = service.get_user_label('me', 'UNREAD')
          puts "✓ Unread messages: #{unread_label.messages_total || 0}"

          puts
          puts '=== All tests passed! ==='
          puts
          puts 'The Gmail MCP server is ready to use.'
          puts "Run 'ruby gmail_server.rb' to start the server."

        rescue Google::Apis::AuthorizationError => e
          puts
          puts "✗ Authorization error: #{e.message}"
          puts "  Try deleting #{token_path} and running this command again."
          exit 1
        rescue Google::Apis::ClientError => e
          puts
          puts "✗ API error: #{e.message}"
          puts '  Make sure Gmail API is enabled in Google Cloud Console.'
          exit 1
        rescue StandardError => e
          puts
          puts "✗ Error: #{e.message}"
          puts e.backtrace.first(5).join("\n")
          exit 1
        end

        private

        def authorize(credentials_path, token_path, scope)
          oob_uri    = 'urn:ietf:wg:oauth:2.0:oob'
          client_id  = Google::Auth::ClientId.from_file(credentials_path)
          token_store = Google::Auth::Stores::FileTokenStore.new(file: token_path)
          authorizer = Google::Auth::UserAuthorizer.new(client_id, scope, token_store)
          user_id    = 'default'
          credentials = authorizer.get_credentials(user_id)

          if credentials.nil?
            url = authorizer.get_authorization_url(base_url: oob_uri)
            puts 'Open the following URL in the browser and enter the resulting code after authorization:'
            puts url
            print 'Code: '
            code = $stdin.gets.chomp
            credentials = authorizer.get_and_store_credentials_from_code(
              user_id: user_id, code: code, base_url: oob_uri
            )
          end

          credentials
        end
      end

      class Reset < Dry::CLI::Command
        desc 'Reset Gmail authorization by deleting the stored token'

        def call(*)
          require 'yaml'
          config_path = File.expand_path('../../config.yml', __FILE__)
          config      = YAML.load_file(config_path)
          token_path  = File.expand_path(config['token_path'])

          if File.exist?(token_path)
            File.delete(token_path)
            puts "✓ Token deleted: #{token_path}"
            puts '  Run `bin/gmail_mcp setup` or `bin/gmail_mcp test` to re-authorize.'
          else
            puts "✓ No token found at #{token_path} (already clean)"
          end
        end
      end

      class Status < Dry::CLI::Command
        desc 'Show current Gmail MCP configuration and authorization status'

        def call(*)
          require 'yaml'
          config_path  = File.expand_path('../../config.yml', __FILE__)
          config       = YAML.load_file(config_path)
          creds_file   = File.expand_path(config['credentials_path'])
          token_path   = File.expand_path(config['token_path'])
          creds_dir    = File.dirname(creds_file)

          puts '=== Gmail MCP Server Status ==='
          puts

          puts "Config directory : #{creds_dir}"
          puts "  #{File.exist?(creds_dir) ? '✓ exists' : '✗ missing'}"
          puts

          puts "Credentials file : #{creds_file}"
          puts "  #{File.exist?(creds_file) ? '✓ exists' : '✗ missing — run setup'}"
          puts

          puts "Auth token       : #{token_path}"
          puts "  #{File.exist?(token_path) ? '✓ exists (authorized)' : '✗ missing — not yet authorized'}"
          puts
        end
      end

      class Server < Dry::CLI::Command
        desc 'Start the Gmail MCP server'

        def call(*)
          server_path = File.expand_path('../../mcp_server.rb', __FILE__)
          unless File.exist?(server_path)
            puts "✗ Server script not found: #{server_path}"
            exit 1
          end
          exec(RbConfig.ruby, server_path)
        end
      end

      register 'setup',  Setup
      register 'test',   Test
      register 'reset',  Reset
      register 'status', Status
      register 'server', Server
    end
  end
end

Dry::CLI.new(GmailMCP::CLI::Commands).call
